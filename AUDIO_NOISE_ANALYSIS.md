# 音声ノイズの原因分析

## 潜在的な問題点

### 1. デューティパターンの問題
**問題**: `dutyPattern` 3が `0b11111100` になっているが、これは bit 2-7 が1で、bit 0-1が0です。
- `dutyPosition` が0-7の範囲で、bit 0-1をチェックする場合、正しく動作しない可能性があります。
- 実機では、duty cycle 3は bit 2-7が1（6/8 = 75%）ですが、bit 0-1もチェックされるため、問題が発生する可能性があります。

**修正案**: dutyPattern 3を `0b11111100` から `0b11111110` または `0b11111111` に変更する必要があるかもしれません。

### 2. 浮動小数点の精度問題
**問題**: `soundCycle % period` や `positionInPeriod * 8.0 / period` などの計算で、浮動小数点の精度誤差が蓄積する可能性があります。
- 特に、`soundCycle` が大きくなると、精度誤差が蓄積される可能性があります。
- `dutyPosition` の計算で、整数変換時の誤差が発生する可能性があります。

**修正案**: 
- `dutyPosition` の計算をより正確にする（四捨五入ではなく切り捨てを使用）
- `soundCycle` の値を定期的に正規化する

### 3. サンプル生成タイミングの同期問題
**問題**: `sampleSoundCycle` の計算が、実際のサウンドサイクルと同期していない可能性があります。
- `currentFrameStart` の計算が不正確な可能性があります。
- `frameStartSoundCycle` の更新タイミングが正しくない可能性があります。

**修正案**: 
- `frameStartSoundCycle` の更新タイミングを確認
- `currentFrameStart` の計算をより正確にする

### 4. エンベロープの更新タイミング
**問題**: エンベロープの更新が `step()` で行われ、サンプル生成が `generateSamples()` で行われるため、タイミングのずれが発生する可能性があります。
- エンベロープの更新がサンプル生成の前に正しく行われているか確認が必要です。

**修正案**: 
- エンベロープの更新タイミングを確認
- サンプル生成時にエンベロープの状態を正確に反映する

### 5. Waveチャンネルの波形RAM読み取り制限
**問題**: Waveチャンネルの波形RAM読み取り制限が正しく実装されていない可能性があります。
- 波形RAMの読み取り制限が、サンプル生成時に正しく反映されていない可能性があります。

**修正案**: 
- 波形RAMの読み取り制限の実装を確認
- サンプル生成時に波形RAMの読み取り制限を考慮する

### 6. スイープ処理のタイミング
**問題**: Square 1のスイープ処理で、`shadowFrequency` の更新タイミングが正しくない可能性があります。
- スイープの更新がサンプル生成の前に正しく行われているか確認が必要です。

**修正案**: 
- スイープの更新タイミングを確認
- `shadowFrequency` の更新をより正確にする

### 7. ボリュームスケーリングの精度
**問題**: ボリュームスケーリングで `2184.5` を使用していますが、これが正確でない可能性があります。
- 実機では、ボリュームスケーリングが異なる可能性があります。

**修正案**: 
- ボリュームスケーリングの計算を確認
- より正確なスケーリング係数を使用する

### 8. ミキシング時のオーバーフロー
**問題**: ミキシング時に、複数のチャンネルを加算する際にオーバーフローが発生する可能性があります。
- 現在は `Long` 型で計算していますが、それでも問題が発生する可能性があります。

**修正案**: 
- ミキシング時のオーバーフロー対策を確認
- より適切なクリッピング処理を実装する

## 優先度の高い修正項目

1. **デューティパターンの修正** (高優先度)
   - dutyPattern 3の値を確認・修正

2. **浮動小数点の精度向上** (高優先度)
   - `dutyPosition` の計算をより正確にする
   - `soundCycle` の正規化を実装

3. **サンプル生成タイミングの同期** (中優先度)
   - `frameStartSoundCycle` の更新タイミングを確認
   - `currentFrameStart` の計算をより正確にする

4. **エンベロープの更新タイミング** (中優先度)
   - エンベロープの更新がサンプル生成の前に正しく行われているか確認

5. **スイープ処理のタイミング** (中優先度)
   - スイープの更新タイミングを確認

