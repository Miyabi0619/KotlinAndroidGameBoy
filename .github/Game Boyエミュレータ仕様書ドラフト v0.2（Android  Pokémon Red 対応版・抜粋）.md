## 1. 方針整理

1. プラットフォーム
    
    - Kotlin + Android（最低限：Android 8.0 以上あたりを想定）
        
    - 画面描画・入力・ファイルアクセスはAndroid Frameworkを使用
        
    - エミュレータコア（CPU／PPU／APU／MBC 等）は、できる限りAndroid依存を排して「純粋Kotlinのライブラリ」として実装（将来、Desktopや他プラットフォームに流用しやすくする）
        
2. 精度方針
    
    - 目標：「ポケモン赤が実機とほぼ同じ挙動で動く」
        
    - そのため、初期版からある程度「サイクル単位」に近い挙動を意識する
        
        - CPU：命令ごとの実行サイクル数を正しくカウント
            
        - PPU：少なくとも「1ライン単位」、可能なら「4モード（OAM, VRAM, HBlank, VBlank）」レベルでタイミングを再現
            
    - APU（音）は、起動だけが目標なら「レジスタの読み書きだけ正しく受けるダミー」でスタートし、あとから本格実装でもよい
        
3. アプリの基本機能
    
    - ストレージから .gb ファイルを選択してロード（SAF / ACTION_OPEN_DOCUMENT 等）
        
    - ROMヘッダを解析して情報表示（タイトル・MBC種別など）
        
    - 「実行開始」「一時停止」「リセット」ボタン
        
    - 画面にゲーム画面を描画、タッチUIでGame Boyボタン入力
        
    - 最小目標：ポケモン赤がタイトル画面まで行き、ニューゲームに入れるところまで
        

---

## 2. ポケモン赤のための最小要件

ポケモン赤（JPN）は典型的な「MBC1 + バッテリ付きRAM」のROMである前提で設計します。

エミュレータ側の「必須レベル」はざっくり以下です。

- CPU
    
    - LR35902 命令セットを全実装（未使用命令も含めるのが安全）
        
    - 中断命令（HALT, STOP）の挙動、割り込み、IMEフラグの扱い
        
- PPU
    
    - BG表示、ウィンドウ表示、スプライト表示
        
    - LCDC, STAT, SCY, SCX, LY, LYC などのレジスタ
        
    - 少なくともスキャンラインごとの更新＋VBlank割り込みのタイミング
        
- タイマー
    
    - DIV/TIMA/TMA/TAC の基本動作
        
    - タイマ割り込み（Timer IRQ）
        
- 割り込み
    
    - VBlank / LCD STAT / Timer / Joypad を実装
        
    - IF / IE / IME の組み合わせ
        
- MBC
    
    - MBC1 のROMバンク切り替え＋RAMバンク切り替え
        
- SRAM（セーブ）
    
    - 起動だけなら必須ではないが、いずれはファイル保存（.sav）の仕様を入れる
        

これらを踏まえて、前回の仕様を Android + ポケモン赤向けに調整したドラフトを書きます。

---

## 3. Game Boyエミュレータ仕様書ドラフト v0.2（Android / Pokémon Red 対応版・抜粋）

### 3.1 プロジェクト概要

3.1.1 名称

- プロジェクト名：Kotlin Game Boy Emulator for Android（仮称：KGBE-Android）
    

3.1.2 目的

- Android端末上でGame Boy（DMG）用ソフトウェアを実行するエミュレータを実装することを目的とする。
    
- 初期バージョンの達成目標を以下とする。
    
    - ポケモン赤（MBC1カートリッジ）のROMを読み込み、タイトル画面からニューゲーム開始までの動作が確認できること。
        
    - 描画と入力が実機と同等に近い挙動で動作すること。
        
    - サウンドは初期段階では簡易またはダミー実装とし、起動とゲーム進行の妨げにならない範囲で対応する。
        

3.1.3 対象プラットフォーム

- 実行環境：Android
    
    - 最低動作バージョン：Android 8.0 (API level 26) を目安とする。
        
- 開発言語：Kotlin
    
- ビルドツール：Gradle (Android Gradle Plugin)
    

3.1.4 精度方針

- 互換性を重視し、可能な限り実機に近い挙動を目指す。
    
- 初期版における精度の方針は以下とする。
    
    - CPU：命令セットを完全実装し、各命令のクロック数を正しくカウントする。
        
    - PPU：スキャンライン単位のタイミング再現を行い、VBlank割り込みを実機に近い位置で発生させる。
        
    - Timer：DIV/TIMAのインクリメントとTimer割り込みタイミングを仕様に沿って実装する。
        
    - APU：レジスタ読書きと電源ON/OFFの状態がゲームロジックに影響しない範囲で実装し、音声波形生成は後続の課題とする。
        

---

### 3.2 ハードウェア仕様（論理モデル）

※ここは前回ドラフトとほぼ同じだが、ポケモン赤対応の観点を明示的に追記する。

3.2.1 CPU概要

- CPU：Sharp LR35902互換
    
- アドレス空間：16bit（0x0000–0xFFFF）
    
- 命令セット：Z80類似の8bit命令セットに専用命令を加えたものとする。
    
- 本エミュレータでは「命令単位の実行」と「機械サイクル数のカウント」を行う。
    

3.2.2 メモリマップ（MBC1を考慮した概略）

- 0x0000–0x3FFF: 固定ROMバンク（バンク0）
    
- 0x4000–0x7FFF: スイッチ可能ROMバンク（MBC1による切り替え）
    
- 0x8000–0x9FFF: VRAM
    
- 0xA000–0xBFFF: 外部RAM（MBC1のRAMバンク）
    
- 0xC000–0xDFFF: WRAM
    
- 0xE000–0xFDFF: ECHO RAM（C000–DDFFのミラー）
    
- 0xFE00–0xFE9F: OAM
    
- 0xFEA0–0xFEFF: 未使用
    
- 0xFF00–0xFF7F: I/Oレジスタ
    
- 0xFF80–0xFFFE: HRAM
    
- 0xFFFF: IE
    

3.2.3 カートリッジ（MBC1）

- ポケモン赤はMBC1を使用するため、MBC1を最初からサポート対象とする。
    
- MBC1の仕様（本仕様書では概略とし、詳細は別章で定義する）。
    
    - アドレス0x0000–0x7FFFへの書き込みにより、ROMバンク選択・RAMバンク選択・モード切り替えを行う。
        
    - RAM Enable レジスタの扱い（0x0Aなど特定値で有効化）。
        
    - 16/4モード（ROMバンク上位ビットの扱い）をサポートする。
        

---

### 3.3 ソフトウェア構成（Android対応版）

3.3.1 モジュール構成

- `emucore` モジュール
    
    - JVM向けの純Kotlinモジュールとして実装する。
        
    - 構成クラス：`Cpu`, `Bus`, `Ppu`, `Timer`, `Joypad`, `Cartridge`, `Mbc1`, `GameBoy` など。
        
- `app-android` モジュール
    
    - Androidアプリ本体。
        
    - 構成要素：
        
        - `MainActivity`（ROM選択、GameView表示）
            
        - `GameSurfaceView` または `Compose` ベースの `GameView`
            
        - 入力UI（オンスクリーンボタン）
            
        - 設定画面（FPS表示オン／オフなど）
            

3.3.2 主なクラス（Android側）

- `GameView`（仮称）
    
    - 責務：エミュレータから受け取ったフレームバッファを画面に描画する。
        
    - 描画周期：
        
        - タイマーまたは `Choreographer` を用いておよそ60FPSで描画する。
            
        - 1フレームごとに `GameBoy.runFrame()` を呼び出す。
            
- `InputController`
    
    - 責務：タッチイベントや仮想ボタン配置からJoypadの状態を生成し、`Joypad` クラスに反映する。
        
- `RomLoader`
    
    - 責務：SAFを通じて選択された`.gb`ファイルをバイト配列として読み込み、`Cartridge` に渡す。
        

---

### 3.4 実行ループ仕様（Android版）

3.4.1 フレーム駆動ループ

- Android側では、画面のリフレッシュレート（60Hz）に同期して1フレーム分のエミュレーションを進める方式を採用する。
    
- `GameBoy` クラスは以下のメソッドを持つ。
    
    - `fun runFrame(): FrameResult`
        
        - 戻り値に1フレーム分のピクセルバッファと、任意でデバッグ情報（FPS, サイクル数など）を含める。
            

3.4.2 サイクル数

- フレームあたりのサイクル数 `CYCLES_PER_FRAME` は約70224サイクルとする。
    
- `runFrame()` 内部では、前述のCPU/PPU/Timer/APUをサイクルベースで進める。
    
- 端末の性能により実時間との差が出る場合があるが、初期版では「エミュレータのサイクルを正しく進めること」を優先し、実時間との完全同期は後続の課題とする。
    

---

### 3.5 Androidアプリの機能仕様（最小構成）

3.5.1 ROM読み込み

- ユーザはアプリ起動後、「ROMを開く」ボタンを押下することで、ストレージ上の`.gb`ファイルを選択できる。
    
- アプリは選択したURIからバイナリデータを読み込み、`Cartridge` インスタンスを生成する。
    
- 読み込み失敗時はエラーダイアログを表示する。
    

3.5.2 実行操作

- 実行／一時停止／リセットのボタンを画面上に表示する。
    
- 実行中は、Game Boy画面と仮想ボタンを同時に表示する。
    
- 一時停止中は `runFrame()` の呼び出しを停止する。
    

3.5.3 入力UI

- 画面下部にGame Boyボタン相当の仮想ボタンを配置する（十字キー／A／B／Start／Select）。
    
- ボタンの押下状態を `Joypad` クラスにリアルタイムで反映させる。
    

---

### 3.6 デバッグ・テスト

3.6.1 テストROM

- 命令セット検証用ROM（blargg’s testなど）によりCPU実装の正しさを検証する。
    
- PPUテストROMを活用し、画面描画の挙動を確認する。
    
- ポケモン赤を実際に起動し、タイトル画面・ニューゲーム画面への到達を確認する。
    

3.6.2 ログ機能

- デバッグビルド時に限り、以下のログ出力を行えるようにする。
    
    - CPU命令トレース
        
    - PPUステータス（LY, STAT, LCDCなど）
        
    - 割り込み情報（IF/IE/IME）