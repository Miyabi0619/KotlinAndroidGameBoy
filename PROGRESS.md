# Game Boy エミュレータ 進捗レポート

## 📊 実装済み機能

### ✅ CPU
- **基本命令セット**: 大部分の命令を実装
  - ロード/ストア命令（LD系）
  - 算術演算（ADD, SUB, ADC, SBC, INC, DEC）
  - 論理演算（AND, OR, XOR, CP）
  - ビット演算（BIT, SET, RES, ROT, SHIFT）
  - ジャンプ/分岐（JP, JR, CALL, RET, RST）
  - スタック操作（PUSH, POP）
  - 特殊命令（HALT, STOP, DI, EI, RETI, DAA, CPL, SCF, CCF）
- **割り込み処理**: IME, IF, IEレジスタの実装
- **HALT/STOP状態**: 基本実装済み

### ✅ メモリ管理
- **SystemBus**: メモリマップの実装
  - ROM (0x0000-0x7FFF)
  - VRAM (0x8000-0x9FFF)
  - WRAM (0xC000-0xDFFF)
  - OAM (0xFE00-0xFE9F)
  - I/Oレジスタ (0xFF00-0xFF7F)
  - HRAM (0xFF80-0xFFFE)
- **MBC1**: ROM/RAMバンク切り替えの実装

### ✅ PPU (Picture Processing Unit)
- **背景描画**: 
  - BGマップ0/1のサポート
  - スクロールレジスタ（SCX/SCY）の実装
  - タイルデータアドレッシングモード（符号付き/符号なし）の実装
  - 背景パレット（BGP）の実装
- **スプライト描画**: 
  - OAMからのスプライト読み取り
  - 8x8/8x16スプライトサイズのサポート
  - X/Y反転の実装
  - パレット選択（OBP0/OBP1）の実装
  - 1スキャンラインあたり最大10個の制限
- **VBlank割り込み**: 実装済み
- **LCDCレジスタ**: 基本機能の実装
  - LCD Enable (bit7)
  - BG Map Select (bit3)
  - Tile Data Select (bit4)
  - Sprite Enable (bit1)
  - Sprite Size (bit2)

### ✅ タイマー
- **DIV/TIMA/TMA/TACレジスタ**: 実装済み
- **タイマー割り込み**: 実装済み

### ✅ 入力処理
- **Joypad**: 実装済み
  - 方向キー（Up/Down/Left/Right）
  - ボタン（A/B/Select/Start）
  - JOYPAD割り込みの実装

### ✅ アプリケーション層
- **ROM読み込み**: ファイル選択機能
- **フレームバッファ表示**: Compose UIでの表示
- **入力UI**: 画面上のボタンとUSBコントローラー対応
- **エラーハンドリング**: 基本実装

## ⚠️ 既知の問題点

### 🔴 重大な問題
1. **スプライトの優先度処理が簡易的**
   - 現在は背景の色を簡易的にチェックしているだけ
   - 実機では背景のカラーIDを保持して、優先度に応じて描画を制御する必要がある

2. **ウィンドウ描画が未実装**
   - LCDC.5 (Window Enable) と LCDC.6 (Window Tile Map) は実装されているが、描画処理がない
   - 多くのゲームでウィンドウ（メニュー、テキストボックスなど）を使用

3. **DMA転送が未実装**
   - OAM DMA (0xFF46) が未実装
   - スプライトデータの転送に必要

### 🟡 中程度の問題
4. **PPUのタイミング処理が不完全**
   - STATレジスタのモード遷移（HBlank, VBlank, OAM Search, Pixel Transfer）が未実装
   - LCD_STAT割り込みが未実装
   - LYC比較割り込みが未実装

5. **未実装のCPU命令の可能性**
   - 実行時にエラーが発生する可能性がある
   - エラーログで確認が必要

6. **HALTバグの未実装**
   - 実機ではHALT状態でIMEが無効の場合、特殊な動作（HALTバグ）が発生
   - 現在は簡略化されている

### 🟢 軽微な問題
7. **サウンド処理が未実装**
   - ゲームプレイには影響しないが、完全性のため必要

8. **セーブステート機能が未実装**
   - ゲームの状態を保存/復元できない

## 🔧 修正が必要な項目（優先順位順）

### 優先度: 高
1. **スプライトの優先度処理の改善**
   - 背景描画時にカラーIDを保持する配列を追加
   - スプライト描画時に優先度に応じて正しく描画

2. **ウィンドウ描画の実装**
   - ウィンドウレジスタ（WX/WY）を使用した描画処理
   - ウィンドウは背景の上に描画される

3. **DMA転送の実装**
   - OAM DMA (0xFF46) の実装
   - 160サイクルでOAMへの転送を完了

### 優先度: 中
4. **PPUのタイミング処理の改善**
   - STATレジスタのモード遷移の実装
   - LCD_STAT割り込みの実装
   - LYC比較割り込みの実装

5. **未実装CPU命令の確認と実装**
   - エラーログを確認して、未実装命令を特定
   - 必要に応じて実装

6. **HALTバグの実装**
   - 実機の動作に合わせてHALTバグを実装

### 優先度: 低
7. **サウンド処理の実装**
   - ゲームプレイには影響しないが、完全性のため

8. **セーブステート機能の実装**
   - ゲームの状態を保存/復元できるように

## 📝 技術的詳細

### PPUの描画順序（現在）
1. 背景描画（BG Map 0/1から）
2. スプライト描画（OAMから、簡易的な優先度処理）

### PPUの描画順序（実機）
1. 背景描画（カラーIDを保持）
2. ウィンドウ描画（カラーIDを保持）
3. スプライト描画（優先度に応じて背景/ウィンドウの上または下に描画）

### スプライトの優先度処理（現在）
- 背景の色を簡易的にチェック（白/黒以外の場合は描画しない）

### スプライトの優先度処理（実機）
- 背景/ウィンドウのカラーID 0以外の上には描画しない（優先度が高い場合）
- カラーID 0は透明として扱う

## 🎯 次のステップ

1. **スプライトの優先度処理の改善**（最優先）
   - 背景描画時にカラーIDを保持
   - スプライト描画時に優先度を正しく処理

2. **ウィンドウ描画の実装**
   - ウィンドウレジスタを使用した描画処理

3. **DMA転送の実装**
   - OAM DMAの実装

4. **PPUのタイミング処理の改善**
   - STATレジスタのモード遷移の実装

