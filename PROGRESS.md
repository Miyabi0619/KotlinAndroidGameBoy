# Game Boy エミュレータ 進捗レポート

## 📊 実装済み機能

### ✅ CPU
- **基本命令セット**: 大部分の命令を実装
  - ロード/ストア命令（LD系）
  - 算術演算（ADD, SUB, ADC, SBC, INC, DEC）
  - 論理演算（AND, OR, XOR, CP）
  - ビット演算（BIT, SET, RES, ROT, SHIFT）
  - ジャンプ/分岐（JP, JR, CALL, RET, RST）
  - スタック操作（PUSH, POP）
  - 特殊命令（HALT, STOP, DI, EI, RETI, DAA, CPL, SCF, CCF）
- **割り込み処理**: IME, IF, IEレジスタの実装
- **HALT/STOP状態**: 基本実装済み

### ✅ メモリ管理
- **SystemBus**: メモリマップの実装
  - ROM (0x0000-0x7FFF)
  - VRAM (0x8000-0x9FFF)
  - WRAM (0xC000-0xDFFF)
  - OAM (0xFE00-0xFE9F)
  - I/Oレジスタ (0xFF00-0xFF7F)
  - HRAM (0xFF80-0xFFFE)
- **MBC1**: ROM/RAMバンク切り替えの実装

### ✅ PPU (Picture Processing Unit)
- **背景描画**: 
  - BGマップ0/1のサポート
  - スクロールレジスタ（SCX/SCY）の実装
  - タイルデータアドレッシングモード（符号付き/符号なし）の実装
  - 背景パレット（BGP）の実装
  - **背景カラーID保持**: スプライト優先度処理用にカラーID配列を保持
- **スプライト描画**: 
  - OAMからのスプライト読み取り
  - 8x8/8x16スプライトサイズのサポート
  - X/Y反転の実装
  - パレット選択（OBP0/OBP1）の実装
  - 1スキャンラインあたり最大10個の制限
  - **優先度処理**: 背景カラーIDに基づく優先度判定を実装
- **VBlank割り込み**: 実装済み
- **LCDCレジスタ**: 基本機能の実装
  - LCD Enable (bit7)
  - BG Map Select (bit3)
  - Tile Data Select (bit4)
  - Sprite Enable (bit1)
  - Sprite Size (bit2)

### ✅ タイマー
- **DIV/TIMA/TMA/TACレジスタ**: 実装済み
- **タイマー割り込み**: 実装済み

### ✅ 入力処理
- **Joypad**: 実装済み
  - 方向キー（Up/Down/Left/Right）
  - ボタン（A/B/Select/Start）
  - JOYPAD割り込みの実装

### ✅ アプリケーション層
- **ROM読み込み**: ファイル選択機能
- **フレームバッファ表示**: Compose UIでの表示
- **入力UI**: 画面上のボタンとUSBコントローラー対応
- **エラーハンドリング**: 基本実装

## ⚠️ 既知の問題点

### 🔴 重大な問題
1. **スプライトの描画順序が不正**
   - 現在はX座標の降順（右から左）で描画している
   - 実機ではOAMの順序（インデックス昇順）で描画する必要がある
   - これにより「手前のスプライトしか表示されない」問題が発生
   - **修正済み**: 背景のカラーIDを保持する配列を追加し、優先度処理は実装済み

2. **ウィンドウ描画が未実装**
   - LCDC.5 (Window Enable) と LCDC.6 (Window Tile Map) は実装されているが、描画処理がない
   - 多くのゲームでウィンドウ（メニュー、テキストボックスなど）を使用

3. **DMA転送が未実装**
   - OAM DMA (0xFF46) が未実装
   - スプライトデータの転送に必要

### 🟡 中程度の問題
4. **PPUのタイミング処理が不完全**
   - STATレジスタのモード遷移（HBlank, VBlank, OAM Search, Pixel Transfer）が未実装
   - LCD_STAT割り込みが未実装
   - LYC比較割り込みが未実装

5. **未実装のCPU命令の可能性**
   - 実行時にエラーが発生する可能性がある
   - エラーログで確認が必要

6. **HALTバグの未実装**
   - 実機ではHALT状態でIMEが無効の場合、特殊な動作（HALTバグ）が発生
   - 現在は簡略化されている

### 🟢 軽微な問題
7. **サウンド処理が未実装**
   - ゲームプレイには影響しないが、完全性のため必要

8. **セーブステート機能が未実装**
   - ゲームの状態を保存/復元できない

## 🔧 修正が必要な項目（優先順位順）

### 優先度: 高
1. **スプライトの描画順序の修正** ⚠️ 現在の問題
   - 現在: X座標の降順（右から左）で描画
   - 実機: OAMの順序（インデックス昇順）で描画
   - 後から描画されたスプライトが前に描画されたスプライトの上に描画される
   - これにより「手前のスプライトしか表示されない」問題が発生

2. **ウィンドウ描画の実装**
   - ウィンドウレジスタ（WX/WY）を使用した描画処理
   - ウィンドウは背景の上に描画される
   - ウィンドウ描画時もカラーIDを保持する必要がある

3. **DMA転送の実装**
   - OAM DMA (0xFF46) の実装
   - 160サイクルでOAMへの転送を完了

### 優先度: 中
4. **PPUのタイミング処理の改善**
   - STATレジスタのモード遷移の実装
   - LCD_STAT割り込みの実装
   - LYC比較割り込みの実装

---

## 📚 Game Boy仕様書との比較結果

### ✅ 仕様に合致している実装

1. **スプライトの優先度処理** ✅
   - 背景カラーIDを保持し、優先度判定を実装
   - 優先度が高い（bit7=1）スプライトは、背景カラーID 0以外の上には描画しない
   - カラーID 0は透明として扱う

2. **スプライトの表示制限** ✅
   - 1スキャンラインあたり最大10個のスプライト（実装済み）
   - 最大40個のスプライト（実装済み）
   - 8x8/8x16スプライトサイズのサポート（実装済み）

3. **PPUの基本機能** ✅
   - 背景描画（BG Map 0/1、スクロール、パレット）
   - スプライト描画（OAM読み取り、X/Y反転、パレット選択）
   - VBlank割り込み（実装済み）

4. **CPU命令セット** ✅
   - 大部分の命令を実装済み
   - 割り込み処理（IME, IF, IE）の実装

5. **メモリ管理** ✅
   - メモリマップの実装
   - MBC1の実装

### ⚠️ 仕様と不一致・修正が必要な項目

#### 🔴 重大な不一致（即座に修正が必要）

1. **スプライトの描画順序が仕様と異なる**
   - **現在の実装**: X座標の降順（右から左）で描画
   - **実機の仕様**: OAMの順序（インデックス昇順）で描画
   - **影響**: 手前のスプライトしか表示されない問題が発生
   - **修正内容**: `renderSprites()`内で`sortedByDescending { X座標 }`を削除し、OAM順序（`spritesOnLine`をそのまま使用）で描画

2. **ウィンドウ描画が未実装**
   - **実機の仕様**: ウィンドウは背景の上に描画され、スプライトの下に描画される
   - **現在の実装**: ウィンドウ描画処理が存在しない
   - **修正内容**: 
     - ウィンドウレジスタ（WX/WY）を使用した描画処理を実装
     - ウィンドウ描画時も`bgColorIds`を更新
     - LCDC.5 (Window Enable) と LCDC.6 (Window Tile Map) の処理を実装

3. **DMA転送が未実装**
   - **実機の仕様**: OAM DMA (0xFF46) は160サイクルでOAMへの転送を完了
   - **現在の実装**: DMA転送処理が存在しない
   - **修正内容**: OAM DMA転送処理を実装（160サイクルで完了）

#### 🟡 中程度の不一致（ゲームプレイに影響する可能性）

4. **PPUのタイミング処理が不完全**
   - **実機の仕様**: STATレジスタのモード遷移（Mode 0: HBlank, Mode 1: VBlank, Mode 2: OAM Search, Mode 3: Pixel Transfer）
   - **現在の実装**: モード遷移が未実装
   - **修正内容**: 
     - STATレジスタのモード遷移を実装
     - 各モードのタイミングを実装（Mode 2: 80サイクル、Mode 3: 172-289サイクル、Mode 0: 残り）
     - LCD_STAT割り込みの実装
     - LYC比較割り込みの実装

5. **スプライトのY座標オフセットの仕様確認**
   - **実機の仕様**: スプライトのY座標は16を引く（Y=0は画面外、Y=16が画面上端）
   - **現在の実装**: `spriteY = oam.getOrElse(oamIndex) { 0u }.toInt() - 16` ✅ 正しい
   - **確認事項**: X座標も同様に8を引いているが、これは正しい（X=0は画面外、X=8が画面左端）

6. **スプライトの優先度処理の詳細確認**
   - **実機の仕様**: 
     - 優先度が低い（bit7=0）: スプライトは常に背景の上に描画される
     - 優先度が高い（bit7=1）: スプライトは背景カラーID 0以外の上には描画されない（背景カラーID 0の上には描画される）
   - **現在の実装**: ✅ 正しく実装されている

#### 🟢 軽微な不一致（完全性のため）

7. **HALTバグの未実装**
   - **実機の仕様**: HALT状態でIMEが無効の場合、特殊な動作（HALTバグ）が発生
   - **現在の実装**: 簡略化されている
   - **修正内容**: 実機の動作に合わせたHALTバグを実装

8. **サウンド処理が未実装**
   - **実機の仕様**: 4つのサウンドチャンネル（Square 1/2, Wave, Noise）
   - **現在の実装**: 未実装
   - **影響**: ゲームプレイには影響しないが、完全性のため必要

9. **セーブステート機能が未実装**
   - **実機の仕様**: 存在しない（エミュレータ固有機能）
   - **現在の実装**: 未実装
   - **影響**: ゲームの状態を保存/復元できない

### 📋 仕様書との比較サマリー

| 項目 | 仕様 | 現在の実装 | 状態 |
|------|------|-----------|------|
| スプライト描画順序 | OAM順序（インデックス昇順） | X座標降順 | ❌ 不一致 |
| スプライト優先度処理 | 背景カラーIDに基づく判定 | 実装済み | ✅ 一致 |
| ウィンドウ描画 | 背景の上、スプライトの下 | 未実装 | ❌ 未実装 |
| DMA転送 | 160サイクルで完了 | 未実装 | ❌ 未実装 |
| STATモード遷移 | Mode 0-3の遷移 | 未実装 | ❌ 未実装 |
| LCD_STAT割り込み | LYC比較、モード割り込み | 未実装 | ❌ 未実装 |
| スプライト表示制限 | 1ライン10個、最大40個 | 実装済み | ✅ 一致 |
| スプライトサイズ | 8x8/8x16 | 実装済み | ✅ 一致 |
| VBlank割り込み | LY=144で発生 | 実装済み | ✅ 一致 |
| 背景描画 | BG Map 0/1、スクロール | 実装済み | ✅ 一致 |

---

## 📋 現状の進捗サマリー（最新更新: 2025-01-XX）

### ✅ 完了した実装
1. **スプライトの優先度処理の改善** ✅
   - 背景描画時にカラーIDを保持する配列（`bgColorIds`）を追加
   - 優先度が高いスプライトは、背景/ウィンドウのカラーID 0以外の上には描画しない
   - 実機の仕様に準拠した優先度処理を実装

### ⚠️ 現在の問題点
1. **スプライトの描画順序が不正**
   - **症状**: 手前のスプライトしか表示されない
   - **原因**: X座標の降順（右から左）で描画しているため、左側のスプライトが後から描画されて、右側のスプライトの上に描画される
   - **実機の仕様**: OAMの順序（インデックス昇順）で描画する必要がある
   - **影響**: 複数のスプライトが重なっている場合、正しく表示されない

### 🔧 実装予定の内容

#### 優先度: 高（即座に対応が必要）
1. **スプライトの描画順序の修正**
   - `renderSprites()`内の描画順序を変更
   - `sortedByDescending { X座標 }` → `spritesOnLine`をそのまま使用（OAM順序）
   - または、OAMのインデックス昇順でソート
   - **期待される効果**: 複数のスプライトが正しく重なって表示される

2. **ウィンドウ描画の実装**
   - ウィンドウレジスタ（WX/WY）の読み取り
   - ウィンドウ描画処理の追加（背景描画と同様の処理）
   - ウィンドウ描画時も`bgColorIds`を更新
   - **期待される効果**: メニューやテキストボックスが表示される

3. **DMA転送の実装**
   - OAM DMA (0xFF46) レジスタの実装
   - 160サイクルでOAMへの転送を完了する処理
   - **期待される効果**: スプライトデータが正しく転送される

#### 優先度: 中（ゲームプレイに影響する可能性）
4. **PPUのタイミング処理の改善**
   - STATレジスタのモード遷移（HBlank, VBlank, OAM Search, Pixel Transfer）
   - LCD_STAT割り込みの実装
   - LYC比較割り込みの実装
   - **期待される効果**: より正確なタイミング処理

5. **未実装CPU命令の確認と実装**
   - 実行時エラーログを確認
   - 必要に応じて未実装命令を実装
   - **期待される効果**: エラーなくゲームが実行される

6. **HALTバグの実装**
   - 実機の動作に合わせたHALTバグの実装
   - **期待される効果**: 実機に近い動作

#### 優先度: 低（完全性のため）
7. **サウンド処理の実装**
   - ゲームプレイには影響しないが、完全性のため
8. **セーブステート機能の実装**
   - ゲームの状態を保存/復元できるように

---

## 📝 技術的詳細

### PPUの描画順序（現在）
1. 背景描画（BG Map 0/1から）
2. スプライト描画（OAMから、簡易的な優先度処理）

### PPUの描画順序（実機）
1. 背景描画（カラーIDを保持）
2. ウィンドウ描画（カラーIDを保持）
3. スプライト描画（優先度に応じて背景/ウィンドウの上または下に描画）

### スプライトの優先度処理（現在）✅ 実装済み
- 背景描画時にカラーIDを保持する配列（`bgColorIds`）を追加
- 優先度が高い（bit7=1）スプライトは、背景/ウィンドウのカラーID 0以外の上には描画しない
- カラーID 0は透明として扱う

### スプライトの描画順序（現在）⚠️ 問題あり
- X座標の降順（右から左）で描画
- これにより、左側のスプライトが後から描画されて、右側のスプライトの上に描画される

### スプライトの描画順序（実機）
- OAMの順序（インデックス昇順）で描画
- 後から描画されたスプライトが前に描画されたスプライトの上に描画される

## 🎯 次のステップ

1. **スプライトの描画順序の修正**（最優先）⚠️ 現在の問題
   - OAMの順序（インデックス昇順）で描画するように変更
   - X座標の降順ではなく、OAMの順序で描画
   - これにより、複数のスプライトが正しく重なって表示される

2. **ウィンドウ描画の実装**
   - ウィンドウレジスタ（WX/WY）を使用した描画処理
   - ウィンドウ描画時もカラーIDを保持

3. **DMA転送の実装**
   - OAM DMA (0xFF46) の実装
   - 160サイクルでOAMへの転送を完了

4. **PPUのタイミング処理の改善**
   - STATレジスタのモード遷移の実装
   - LCD_STAT割り込みの実装

