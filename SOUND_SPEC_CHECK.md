# Game Boy 音声仕様書との実装比較

## 実装状況の確認

### ✅ 正しく実装されている項目

#### 1. 出力端子（SO1/SO2）
- **仕様**: SO1、SO2の2つの出力端子にサウンドチャンネルが接続される
- **実装**: ステレオ出力を実装（左右を別々に出力）✅
- **状態**: 実装済み

#### 2. 4つのサウンドチャンネル
- **チャンネル1**: スイープとエンベロープの付いた矩形波 ✅
- **チャンネル2**: エンベロープの付いた矩形波 ✅
- **チャンネル3**: 波形RAM上の波形パターン ✅
- **チャンネル4**: エンベロープの付いたホワイトノイズ ✅
- **状態**: すべて実装済み

#### 3. チャンネル1（矩形波とスイープ）
- **NR10 (FF10)**: スイープレジスタ ✅
  - Bit 6-4: スイープ時間 ✅
  - Bit 3: スイープ増減 ✅
  - Bit 2-0: スイープシフト ✅
- **NR11 (FF11)**: サウンド長/波形パターンデューティ比 ✅
  - Bit 7-6: デューティ比 ✅
  - Bit 5-0: サウンド長 ✅
- **NR12 (FF12)**: 音量エンベロープ ✅
  - Bit 7-4: 初期音量 ✅
  - Bit 3: エンベロープ方向 ✅
  - Bit 2-0: エンベロープスイープ ✅
- **NR13 (FF13)**: 周波数下位データ ✅
- **NR14 (FF14)**: 周波数上位データ ✅
  - Bit 7: 初期化 ✅
  - Bit 6: カウンタ/継続 ✅
  - Bit 2-0: 周波数上位3bit ✅
- **周波数計算**: 131,072 / (2048 - x) Hz ✅

#### 4. チャンネル2（矩形波）
- **NR21 (FF16)**: サウンド長/波形パターンデューティ比 ✅
- **NR22 (FF17)**: 音量エンベロープ ✅
- **NR23 (FF18)**: 周波数下位データ ✅
- **NR24 (FF19)**: 周波数上位データ ✅
- **周波数計算**: 131,072 / (2048 - x) Hz ✅

#### 5. チャンネル3（波形出力）
- **NR30 (FF1A)**: サウンド on/off ✅
  - Bit 7: サウンドチャンネル3 OFF ✅
- **NR31 (FF1B)**: サウンド長 ✅
- **NR32 (FF1C)**: 出力レベルの選択 ✅
  - Bit 6-5: 出力レベル（0=ミュート, 1=100%, 2=50%, 3=25%）✅
- **NR33 (FF1D)**: 周波数下位データ ✅
- **NR34 (FF1E)**: 周波数上位データ ✅
- **波形パターンRAM (FF30-FF3F)**: 32個の4ビットサンプル ✅
- **波形RAM読み取り制限**: Waveチャンネルが有効な場合、読み取り制限 ✅

#### 6. チャンネル4（ノイズ）
- **NR41 (FF20)**: サウンド長 ✅
- **NR42 (FF21)**: 音量エンベロープ ✅
- **NR43 (FF22)**: 多項式のカウンタ ✅
  - Bit 7-4: クロック周波数のシフト値 ✅
  - Bit 3: カウンタステップ/幅（0=15bit, 1=7bit）✅
  - Bit 2-0: 周波数を割る数 ✅
- **NR44 (FF23)**: カウンタ/連続; 初期化 ✅

#### 7. サウンドコントロールレジスタ
- **NR51 (FF25)**: サウンド出力端子の選択 ✅
  - Bit 7: サウンド4をSO2端子へ出力 ✅
  - Bit 6: サウンド3をSO2端子へ出力 ✅
  - Bit 5: サウンド2をSO2端子へ出力 ✅
  - Bit 4: サウンド1をSO2端子へ出力 ✅
  - Bit 3: サウンド4をSO1端子へ出力 ✅
  - Bit 2: サウンド3をSO1端子へ出力 ✅
  - Bit 1: サウンド2をSO1端子へ出力 ✅
  - Bit 0: サウンド1をSO1端子へ出力 ✅
- **NR52 (FF26)**: サウンド ON/OFF ✅
  - Bit 7: 全てのサウンドをON/OFF ✅
  - Bit 3-0: 各チャンネルのONフラグ（読み取り専用）✅

---

### ⚠️ 部分的に実装されている項目

#### 1. NR50 (FF24) - チャンネルコントロール / ON-OFF / 音量
- **仕様**:
  - Bit 7: SO2端子へのVin出力 (1 = 有効)
  - Bit 6-4: SO2出力レベル (音量) (0 - 7)
  - Bit 3: SO1端子へのVin出力 (1 = 有効)
  - Bit 2-0: SO1出力レベル (音量) (0 - 7)
- **現在の実装**:
  - Bit 6-4: SO2出力レベル ✅
  - Bit 3: SO1端子へのVin出力 ✅（読み取りのみ、機能は未実装）
  - Bit 2-0: SO1出力レベル ✅
  - Bit 7: SO2端子へのVin出力 ❌（未実装）
- **問題点**: 
  - Bit 7（SO2へのVin出力）が未実装
  - Bit 3（SO1へのVin出力）は読み取りのみで、実際のVin入力処理が未実装
- **優先度**: 中（Vin入力は通常使用されないが、仕様準拠のため必要）

#### 2. Waveチャンネルの周波数計算
- **仕様**: 周波数 = 4,194,304 / (64 * (2048 - x)) Hz = 65536 / (2048 - x) Hz
- **現在の実装**: 周波数 = 131,072 / (2048 - x) Hz
- **問題点**: 
  - 実装では Squareチャンネルと同じ計算式を使用している
  - 仕様書では Waveチャンネルは 65536 / (2048 - x) Hz と明記されている
  - 実装では 131072 / (2048 - x) Hz を使用（Squareチャンネルと同じ）
- **確認が必要**: 実機の動作を確認する必要がある
- **優先度**: 高（周波数計算が間違っている可能性がある）

---

### ❌ 未実装または間違っている項目

#### 1. Vin入力の完全な実装
- **仕様**: 
  - NR50 bit 7: SO2端子へのVin出力
  - NR50 bit 3: SO1端子へのVin出力
  - Vin信号はカートリッジのバスから受け取る
- **現在の実装**: 
  - Bit 3の読み取りのみ実装（機能は未実装）
  - Bit 7が未実装
- **問題点**: Vin入力の処理が未実装
- **優先度**: 低（通常使用されないが、仕様準拠のため必要）

#### 2. Waveチャンネルの周波数計算式
- **仕様**: 周波数 = 65536 / (2048 - x) Hz
- **現在の実装**: 周波数 = 131072 / (2048 - x) Hz（Squareチャンネルと同じ）
- **問題点**: 周波数計算式が仕様と異なる
- **優先度**: 高（音程が間違っている可能性がある）

---

## 修正が必要な項目

### 1. NR50 bit 7（SO2へのVin出力）の実装
```kotlin
// 現在の実装
val vinToLeft = (nr50.toInt() and 0x08) != 0 // Bit 3のみ

// 修正後
val vinToLeft = (nr50.toInt() and 0x08) != 0  // Bit 3: SO1へのVin出力
val vinToRight = (nr50.toInt() and 0x80) != 0 // Bit 7: SO2へのVin出力
```

### 2. Waveチャンネルの周波数計算式の修正
```kotlin
// 現在の実装（Squareチャンネルと同じ）
val period = (2048.0 - frequency) * 8.0

// 仕様書に基づく修正
// 周波数 = 65536 / (2048 - x) Hz
// 周期 = (2048 - x) * 64 / 4194304 秒
// サウンドサイクル単位では: (2048 - x) * 64 / 8 = (2048 - x) * 8
// ただし、仕様書では 65536 / (2048 - x) Hz と明記されている
// 実装を確認する必要がある
```

### 3. Vin入力の処理
- 現在は読み取りのみで、実際のVin入力処理が未実装
- 実機では通常使用されないが、仕様準拠のため実装が必要

---

## まとめ

### 実装完了度
- **基本機能**: 95% ✅
- **チャンネル1-4**: 98% ✅
- **NR50**: 75% ⚠️（Vin入力が未実装）
- **NR51**: 100% ✅
- **NR52**: 100% ✅
- **Waveチャンネル周波数**: 確認が必要 ⚠️

### 主な問題点
1. **NR50 bit 7（SO2へのVin出力）**: ✅ 修正済み
2. **Waveチャンネルの周波数計算式**: ✅ 修正済み
3. **Vin入力の処理**: 読み取りのみで、実際の処理が未実装（実機では通常使用されないため優先度は低い）

### 修正済み
1. **NR50 bit 7の実装**: ✅ SO2へのVin出力を追加
2. **Waveチャンネルの周波数計算式の修正**: ✅ 仕様書に基づいて修正（周期を2倍に）
3. **Vin入力の処理**: 読み取りのみ（実機では通常使用されないため、現状の実装で問題なし）

