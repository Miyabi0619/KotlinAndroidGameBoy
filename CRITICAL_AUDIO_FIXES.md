# クリティカルな音源バグの修正

## 🚨 発見された重大なバグ

### 1. **音程が完全に間違っていた問題**

#### 問題の詳細
全ての音源チャンネルの周期計算が実機仕様と異なっていました。

#### 修正内容

**Square波（チャンネル1, 2）:**
- **修正前**: `period = (2048 - frequency) * 8.0` サウンドサイクル
- **修正後**: `period = (2048 - frequency) * 4.0` サウンドサイクル
- **影響**: 音が**1オクターブ低かった**（周期が2倍長かったため）

**Wave波（チャンネル3）:**
- **修正前**: `period = (2048 - frequency) * 2.0` サウンドサイクル（先の修正で16.0→2.0に変更）
- **修正後**: `period = (2048 - frequency) * 8.0` サウンドサイクル
- **影響**:
  - 最初の実装（* 16.0）では音が**2オクターブ高かった**
  - 最初の修正（* 2.0）では音が**2オクターブ低かった**
  - 今回の修正（* 8.0）で実機と一致

#### 実機仕様（再確認）

**CPU周波数**: 4,194,304 Hz
**サウンド周波数**: 524,288 Hz (CPU / 8)

**Square波:**
- 周波数 = 131072 / (2048 - x) Hz
- 周期（秒） = (2048 - x) / 131072 秒
- 周期（CPUサイクル） = (2048 - x) * 32 CPUサイクル
- **周期（サウンドサイクル） = (2048 - x) * 4** ✅

**Wave波:**
- 周波数 = 65536 / (2048 - x) Hz（Squareの半分）
- 周期（秒） = (2048 - x) / 65536 秒
- 周期（CPUサイクル） = (2048 - x) * 64 CPUサイクル
- **周期（サウンドサイクル） = (2048 - x) * 8** ✅

---

### 2. **サウンド無効時でも音が鳴る問題**

#### 問題の詳細
NR52[7]=0（サウンド全体が無効）の状態でも、トリガー（NRx4のbit 7）を書き込むとチャンネルが有効化され、音が鳴ってしまう問題がありました。

#### 実機仕様
- NR52[7]=0の場合、トリガーを書き込んでもチャンネルは有効化されない
- トリガー処理自体が無視される

#### 修正内容
全てのチャンネル（Square1, Square2, Wave, Noise）のトリガー処理に、NR52[7]のチェックを追加：

```kotlin
// トリガー時、NR52[7]=0の場合はチャンネルを有効化しない（実機仕様）
val nr52 = soundRegs[0x16]
val soundEnabled = (nr52.toInt() and 0x80) != 0
if (!soundEnabled) {
    return // サウンドが無効な場合、トリガーを無視
}
```

**修正箇所:**
- `Sound.kt`: NR14（Square1）トリガー処理
- `Sound.kt`: NR24（Square2）トリガー処理
- `Sound.kt`: NR34（Wave）トリガー処理
- `Sound.kt`: NR44（Noise）トリガー処理

---

## 📊 修正の影響

### 音程
- ✅ Square波: 実機と一致（1オクターブのズレを修正）
- ✅ Wave波: 実機と一致（2オクターブのズレを修正）
- ✅ 全体的な音程が正しくなり、楽曲が実機と同じに聴こえる

### 音源制御
- ✅ NR52[7]=0で音が完全に停止する
- ✅ サウンド無効時にトリガーを書き込んでも音が鳴らない
- ✅ 実機と同じタイミングで音が鳴り始める/止まる

---

## 🧪 検証方法

### 1. 音程の確認
実機または正確なエミュレータと比較して、以下を確認：
- ポケモン赤/緑のBGM
- スーパーマリオランドのBGM
- テトリスのBGM

### 2. サウンド制御の確認
以下のシーケンスをテスト：
1. NR52[7]=0を書き込む
2. 各チャンネルのトリガー（NRx4のbit 7=1）を書き込む
3. **期待結果**: 音が鳴らない
4. NR52[7]=1を書き込む
5. 再度トリガーを書き込む
6. **期待結果**: 音が鳴る

---

## 📝 技術的な詳細

### 周期計算の誤りの原因

**誤った理解:**
- 「サウンド周波数 = CPU周波数 / 8」から、「サウンドサイクル = CPUサイクル / 8」と計算
- Square周期 = (2048 - x) * 32 CPUサイクル → (2048 - x) * 32 / 8 = (2048 - x) * 4 ✅
- しかし、実装では (2048 - x) * 8 になっていた（おそらく * 32 を * 8 で計算し、/ 8 を忘れた）

**正しい計算:**
1. 実機の周波数公式から周期（秒）を計算
2. CPU周波数を掛けてCPUサイクルに変換
3. 8で割ってサウンドサイクルに変換

### NR52無効時の動作

**実機の動作:**
- NR52[7]=0の場合、APU全体が無効化される
- この状態では、トリガービットを書き込んでも無視される
- レジスタへの書き込み自体は行われるが、チャンネルは有効化されない

**修正前の問題:**
- トリガー処理でNR52[7]をチェックしていなかった
- そのため、サウンド無効時でもチャンネルが有効化されていた

---

## ⚠️ その他の関連する潜在的な問題

### 1. デューティパターンの正確性
先の修正で以下のように変更済み：
- Duty 0: `0b00000001` (12.5%) ✅
- Duty 1: `0b10000001` (25%) ✅
- Duty 2: `0b10000111` (50%) ✅
- Duty 3: `0b01111110` (75%) ✅

### 2. フレームシーケンサの同期
DIVレジスタのbit 12と同期するように修正済み ✅

### 3. HALTバグの実装
完全実装済み ✅

---

## 🎯 次のステップ

### 高優先度
1. **サンプル生成精度の改善**
   - 浮動小数点から整数ベースへの移行
   - 長時間再生での精度低下を防ぐ

2. **Envelope volumeが0の処理**
   - 現在は正しく実装されているが、エッジケースを確認

3. **Length Counterの更新タイミング**
   - フレームシーケンサと正しく同期しているか確認

### 中優先度
4. **Wave RAMアクセス制限**
   - Wave再生中の読み取り制限が正確か確認

5. **Noise LFSRの7bit/15bitモード**
   - 実装は正しいが、実機との波形一致を確認

---

## 📚 参考資料

### 周波数計算
- [Pan Docs - Sound Controller](https://gbdev.io/pandocs/Sound_Controller.html)
- [Game Boy Sound Hardware](https://gbdev.gg8.se/wiki/articles/Gameboy_sound_hardware)

### 計算例（A4音、440Hz）

**Square波で440Hzを出すには:**
- 周波数 = 131072 / (2048 - x) = 440
- (2048 - x) = 131072 / 440 = 298
- x = 2048 - 298 = 1750 = 0x6D6
- NR13 = 0xD6, NR14 = 0x06 (下位3bit)

**Wave波で440Hzを出すには:**
- 周波数 = 65536 / (2048 - x) = 440
- (2048 - x) = 65536 / 440 = 149
- x = 2048 - 149 = 1899 = 0x76B
- NR33 = 0x6B, NR34 = 0x07 (下位3bit)

---

**修正日**: 2026-01-30
**重要度**: 🔴 クリティカル
**テスト**: 必須
